
<!-- README.md is generated from README.Rmd. Please edit that file -->

# rcmip6

<!-- badges: start -->

[![Codecov test
coverage](https://codecov.io/gh/eliocamp/rcmip6/branch/main/graph/badge.svg)](https://app.codecov.io/gh/eliocamp/rcmip6?branch=main)
[![R-CMD-check](https://github.com/eliocamp/rcmip6/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/eliocamp/rcmip6/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The goal of rcmip6 is to search and download data from the CMIP6
project.

## Installation

You can install the development version of rcmip6 like so:

``` r
remotes::install_github("eliocamp/rcmip6")
```

## Example

Search models, variables, etc… using `cmip_search()`

``` r
library(rcmip6)

query <- list(
  type               = "Dataset",
  replica            = "false",
  latest             = "true",
  variable_id        = "tas",
  project            = "CMIP6",
  frequency          = "mon",                          
  table_id           = "Amon",
  experiment_id      = "historical",
  source_id          = "CanESM5"
)

results <- cmip_search(query)
cmip_info(results)
#> Found 65 results (with 0 replicas) totalling 3252Mb.
```

Sumary of results:

``` r
results |> 
  cmip_simplify() |>   # To keep only the most informative columns
  subset(, select = -full_info) |> 
  head(10) |> 
  knitr::kable()
```

| mip_era | activity_drs | institution_id | source_id | experiment_id | member_id | table_id | variable_id | grid_label | version  | variable_long_name           | datetime_start       | datetime_stop        | nominal_resolution |
|:--------|:-------------|:---------------|:----------|:--------------|:----------|:---------|:------------|:-----------|:---------|:-----------------------------|:---------------------|:---------------------|:-------------------|
| CMIP6   | CMIP         | CCCma          | CanESM5   | historical    | r10i1p2f1 | Amon     | tas         | gn         | 20190429 | Near-Surface Air Temperature | 1850-01-16T12:00:00Z | 2014-12-16T12:00:00Z | 500 km             |
| CMIP6   | CMIP         | CCCma          | CanESM5   | historical    | r7i1p2f1  | Amon     | tas         | gn         | 20190429 | Near-Surface Air Temperature | 1850-01-16T12:00:00Z | 2014-12-16T12:00:00Z | 500 km             |
| CMIP6   | CMIP         | CCCma          | CanESM5   | historical    | r8i1p2f1  | Amon     | tas         | gn         | 20190429 | Near-Surface Air Temperature | 1850-01-16T12:00:00Z | 2014-12-16T12:00:00Z | 500 km             |
| CMIP6   | CMIP         | CCCma          | CanESM5   | historical    | r9i1p2f1  | Amon     | tas         | gn         | 20190429 | Near-Surface Air Temperature | 1850-01-16T12:00:00Z | 2014-12-16T12:00:00Z | 500 km             |
| CMIP6   | CMIP         | CCCma          | CanESM5   | historical    | r23i1p2f1 | Amon     | tas         | gn         | 20190429 | Near-Surface Air Temperature | 1850-01-16T12:00:00Z | 2014-12-16T12:00:00Z | 500 km             |
| CMIP6   | CMIP         | CCCma          | CanESM5   | historical    | r14i1p2f1 | Amon     | tas         | gn         | 20190429 | Near-Surface Air Temperature | 1850-01-16T12:00:00Z | 2014-12-16T12:00:00Z | 500 km             |
| CMIP6   | CMIP         | CCCma          | CanESM5   | historical    | r16i1p2f1 | Amon     | tas         | gn         | 20190429 | Near-Surface Air Temperature | 1850-01-16T12:00:00Z | 2014-12-16T12:00:00Z | 500 km             |
| CMIP6   | CMIP         | CCCma          | CanESM5   | historical    | r17i1p2f1 | Amon     | tas         | gn         | 20190429 | Near-Surface Air Temperature | 1850-01-16T12:00:00Z | 2014-12-16T12:00:00Z | 500 km             |
| CMIP6   | CMIP         | CCCma          | CanESM5   | historical    | r22i1p2f1 | Amon     | tas         | gn         | 20190429 | Near-Surface Air Temperature | 1850-01-16T12:00:00Z | 2014-12-16T12:00:00Z | 500 km             |
| CMIP6   | CMIP         | CCCma          | CanESM5   | historical    | r11i1p2f1 | Amon     | tas         | gn         | 20190429 | Near-Surface Air Temperature | 1850-01-16T12:00:00Z | 2014-12-16T12:00:00Z | 500 km             |

The, download the data. Just as a demonstration, download only the first
result

``` r
cmip_root_set("readme_example")   # Set the root folder where to save files 
options(timeout = 360)            # Kind of important for some reason

files <- cmip_download(results[1])
#> Downloading tas_Amon_CanESM5_historical_r10i1p2f1_gn_185001-201412.nc...
#> Downloading from http://crd-esgf-drc.ec.gc.ca/thredds/fileServer/esgC_dataroot/AR6/CMIP6/CMIP/CCCma/CanESM5/historical/r10i1p2f1/Amon/tas/gn/v20190429/tas_Amon_CanESM5_historical_r10i1p2f1_gn_185001-201412.nc
#>   |                                                                              |                                                                      |   0%  |                                                                              |                                                                      |   1%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |==                                                                    |   4%  |                                                                              |===                                                                   |   4%  |                                                                              |===                                                                   |   5%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |=====                                                                 |   8%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |=======                                                               |  11%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |=========                                                             |  14%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  16%  |                                                                              |============                                                          |  17%  |                                                                              |============                                                          |  18%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |==============                                                        |  21%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  22%  |                                                                              |================                                                      |  23%  |                                                                              |================                                                      |  24%  |                                                                              |=================                                                     |  24%  |                                                                              |=================                                                     |  25%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |===================                                                   |  28%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |=====================                                                 |  31%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |=======================                                               |  34%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |==========================                                            |  38%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  39%  |                                                                              |============================                                          |  40%  |                                                                              |============================                                          |  41%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |==============================                                        |  44%  |                                                                              |===============================                                       |  44%  |                                                                              |===============================                                       |  45%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |=================================                                     |  48%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |===================================                                   |  51%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |=====================================                                 |  54%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  56%  |                                                                              |========================================                              |  57%  |                                                                              |========================================                              |  58%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |==========================================                            |  61%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  62%  |                                                                              |============================================                          |  63%  |                                                                              |============================================                          |  64%  |                                                                              |=============================================                         |  64%  |                                                                              |=============================================                         |  65%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |===============================================                       |  68%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |=================================================                     |  71%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |===================================================                   |  74%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  76%  |                                                                              |======================================================                |  77%  |                                                                              |======================================================                |  78%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  79%  |                                                                              |========================================================              |  80%  |                                                                              |========================================================              |  81%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |==========================================================            |  84%  |                                                                              |===========================================================           |  84%  |                                                                              |===========================================================           |  85%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |=============================================================         |  88%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |===============================================================       |  91%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |=================================================================     |  94%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |====================================================================  |  98%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================|  99%  |                                                                              |======================================================================| 100%
```

The files are saved mirroring the source file structure to ensure that
each file is unique.

``` r
fs::dir_tree(cmip_root_get())
#> readme_example
#> └── CMIP6
#>     └── CMIP
#>         └── CCCma
#>             └── CanESM5
#>                 └── historical
#>                     └── r10i1p2f1
#>                         └── Amon
#>                             └── tas
#>                                 └── gn
#>                                     └── 20190429
#>                                         ├── model.info
#>                                         ├── tas_Amon_CanESM5_historical_r10i1p2f1_gn_185001-201412.log
#>                                         ├── tas_Amon_CanESM5_historical_r10i1p2f1_gn_185001-201412.nc
#>                                         └── tas_Amon_CanESM5_historical_r10i1p2f1_gn_185001-201412.nc.chksum
```

This structure can be parsed with `cmip_available()`

``` r
cmip_available()
#>                                                                                           id
#> 1: CMIP6.CMIP.CCCma.CanESM5.historical.r10i1p2f1.Amon.tas.gn.v20190429|crd-esgf-drc.ec.gc.ca
#>     version                         access activity_drs activity_id
#> 1: 20190429 HTTPServer,GridFTP,OPENDAP,LAS         CMIP        CMIP
#>    cf_standard_name
#> 1:  air_temperature
#>                                                                                                        citation_url
#> 1: http://cera-www.dkrz.de/WDCC/meta/CMIP6/CMIP6.CMIP.CCCma.CanESM5.historical.r10i1p2f1.Amon.tas.gn.v20190429.json
#>                data_node data_specs_version
#> 1: crd-esgf-drc.ec.gc.ca           01.00.29
#>                                                                                                                         dataset_id_template_
#> 1: %(mip_era)s.%(activity_drs)s.%(institution_id)s.%(source_id)s.%(experiment_id)s.%(member_id)s.%(table_id)s.%(variable_id)s.%(grid_label)s
#>          datetime_start        datetime_stop
#> 1: 1850-01-16T12:00:00Z 2014-12-16T12:00:00Z
#>                                                                                                                                        directory_format_template_
#> 1: %(root)s/%(mip_era)s/%(activity_drs)s/%(institution_id)s/%(source_id)s/%(experiment_id)s/%(member_id)s/%(table_id)s/%(variable_id)s/%(grid_label)s/%(version)s
#>    east_degrees experiment_id                          experiment_title
#> 1:     357.1875    historical all-forcing simulation of the recent past
#>    frequency
#> 1:       mon
#>                                                                further_info_url
#> 1: https://furtherinfo.es-doc.org/CMIP6.CCCma.CanESM5.historical.none.r10i1p2f1
#>                                                                                     geo
#> 1: ENVELOPE(-180.0, -2.8125, 87.8638, -87.8638),ENVELOPE(0.0, 180.0, 87.8638, -87.8638)
#>       geo_units
#> 1: degrees_east
#>                                                                                                           grid
#> 1: T63L49 native atmosphere, T63 Linear Gaussian Grid; 128 x 64 longitude/latitude; 49 levels; top level 1 hPa
#>    grid_label         index_node
#> 1:         gn esgf-node.llnl.gov
#>                                                            instance_id
#> 1: CMIP6.CMIP.CCCma.CanESM5.historical.r10i1p2f1.Amon.tas.gn.v20190429
#>    institution_id latest
#> 1:          CCCma   TRUE
#>                                                    master_id member_id mip_era
#> 1: CMIP6.CMIP.CCCma.CanESM5.historical.r10i1p2f1.Amon.tas.gn r10i1p2f1   CMIP6
#>    model_cohort nominal_resolution north_degrees number_of_aggregations
#> 1:   Registered             500 km       87.8638                      2
#>    number_of_files                                               pid
#> 1:               1 hdl:21.14100/5acc469d-b400-3c06-b1de-3f4142d90fc9
#>         product project realm replica     size source_id source_type
#> 1: model-output   CMIP6 atmos   FALSE 52462806   CanESM5       AOGCM
#>    south_degrees sub_experiment_id table_id
#> 1:      -87.8638              none     Amon
#>                                                        title    type
#> 1: CMIP6.CMIP.CCCma.CanESM5.historical.r10i1p2f1.Amon.tas.gn Dataset
#>                                                                                                                                                                                                                                                                                                                                                                                                                url
#> 1: http://crd-esgf-drc.ec.gc.ca/thredds/catalog/esgcet/169/CMIP6.CMIP.CCCma.CanESM5.historical.r10i1p2f1.Amon.tas.gn.v20190429.xml#CMIP6.CMIP.CCCma.CanESM5.historical.r10i1p2f1.Amon.tas.gn.v20190429|application/xml+thredds|THREDDS,http://crd-esgf-drc.ec.gc.ca/las/getUI.do?catid=2D7D52D9ABAF43CDC673C1D95DCBF3BC_ns_CMIP6.CMIP.CCCma.CanESM5.historical.r10i1p2f1.Amon.tas.gn.v20190429|application/las|LAS
#>    variable variable_id           variable_long_name variable_units
#> 1:      tas         tas Near-Surface Air Temperature              K
#>    variant_label west_degrees
#> 1:     r10i1p2f1            0
#>                                                                                                                                                                                                                 xlink
#> 1: http://cera-www.dkrz.de/WDCC/meta/CMIP6/CMIP6.CMIP.CCCma.CanESM5.historical.r10i1p2f1.Amon.tas.gn.v20190429.json|Citation|citation,http://hdl.handle.net/hdl:21.14100/5acc469d-b400-3c06-b1de-3f4142d90fc9|PID|pid
#>       _version_ retracted               _timestamp score branch_method
#> 1: 1.637114e+18     FALSE 2019-06-23T06:59:01.531Z     1            NA
#>    short_description
#> 1:                NA
#>                                                                                                                                                                                                                                                                                             files
#> 1: readme_example/CMIP6/CMIP/CCCma/CanESM5/historical/r10i1p2f1/Amon/tas/gn/20190429/tas_Amon_CanESM5_historical_r10i1p2f1_gn_185001-201412.nc,readme_example/CMIP6/CMIP/CCCma/CanESM5/historical/r10i1p2f1/Amon/tas/gn/20190429/tas_Amon_CanESM5_historical_r10i1p2f1_gn_185001-201412.nc.chksum
```
